{ "name": "Ultimate Email Processing - German Club Cairns (Test)", "nodes": [ { "parameters": { "content": "## üß† Intelligenter Email-Hub (TEST VERSION)\n\n**‚ö†Ô∏è TESTMODUS AKTIV: Keine echten E-Mails werden gesendet!**\n\n**Verarbeitet ALLE Emails:**\n1. Table Bookings (WPForms) ‚Üí Capacity Check\n2. Room Hire Requests ‚Üí Calendar\n3. Allgemeine Anfragen ‚Üí Claude antwortet\n4. Rechnungen ‚Üí Telegram Alert\n5. Spam ‚Üí Automatisch labeln\n\n**Neue Features:**\n‚úÖ Datenvalidierung\n‚úÖ Dynamische Kapazit√§tsgrenzen\n‚úÖ Fehlerbehandlung & Benachrichtigungen\n‚úÖ Testmodus\n‚úÖ Eskalation bei niedriger Confidence", "height": 400, "width": 560 }, "id": "dc211f02-fdf8-45c5-9a67-aa53446f8981", "name": "üìã Overview (Test)", "type": "n8n-nodes-base.stickyNote", "position": [ 96, -112 ], "typeVersion": 1 }, { "parameters": { "pollTimes": { "item": [ { "mode": "everyMinute" } ] }, "simple": false, "filters": { "readStatus": "unread" }, "options": {} }, "id": "6cbf5b4b-8b25-4a43-83d6-7e0304434406", "name": "Gmail Trigger - All Emails (Test)", "type": "n8n-nodes-base.gmailTrigger", "position": [ 96, 256 ], "typeVersion": 1.3, "credentials": { "gmailOAuth2": { "id": "l9PcU4X8DUTKXzfX", "name": "Gmail account 3" } } }, { "parameters": { "operation": "get", "messageId": "={{ $json.id }}", "simple": false, "options": {} }, "id": "0223c4d1-37b0-4c0b-8a09-be9ddf1e9047", "name": "Gmail - Get Full Message (Test)", "type": "n8n-nodes-base.gmail", "position": [ 336, 256 ], "typeVersion": 2.1, "webhookId": "d0ce04d6-7160-4f0b-9508-a1527c4429ad", "credentials": { "gmailOAuth2": { "id": "l9PcU4X8DUTKXzfX", "name": "Gmail account 3" } } }, { "parameters": { "assignments": { "assignments": [ { "id": "prep1", "name": "emailSubject", "type": "string", "value": "={{ $json.subject || $json.Subject || '' }}" }, { "id": "prep2", "name": "emailBody", "type": "string", "value": "={{ $json.text || $json.snippet || '' }}" }, { "id": "prep3", "name": "emailFrom", "type": "string", "value": "={{ $json.fromAddress || ($json.from?.value?.[0]?.address) || '' }}" }, { "id": "prep4", "name": "emailFromName", "type": "string", "value": "={{ $json.fromName || ($json.from?.value?.[0]?.name) || '' }}" }, { "id": "prep5", "name": "emailId", "type": "string", "value": "={{ $json.id }}" }, { "id": "prep6", "name": "rawCombined", "type": "string", "value": "={{ 'FROM: ' + ($json.fromAddress || '') + '\\nSUBJECT: ' + ($json.subject || '') + '\\n\\n' + ($json.text || $json.snippet || '') }}" } ] }, "options": {} }, "id": "ebbb37de-878b-4dfa-aa89-e5412ecdbe52", "name": "Prepare Email Data (Test)", "type": "n8n-nodes-base.set", "position": [ 576, 256 ], "typeVersion": 3.4 }, { "parameters": { "model": "openrouter/auto", "options": {} }, "id": "b8f82683-07f1-484c-9a2d-efd03961110a", "name": "OpenRouter - Classify Email (Test)", "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi", "position": [ 816, 256 ], "typeVersion": 1, "credentials": { "openAiApi": { "id": "sfcSHBPiUEmWSjBM", "name": "OpenAi account" } } }, { "parameters": { "promptType": "define", "text": "={{ 'Du bist ein Email-Klassifizierungs-Assistent f√ºr den German Club Cairns.\\n\\nAnalysiere diese Email und extrahiere alle Daten. Antworte NUR mit validem JSON (kein Text davor/danach):\\n\\n' + $json.rawCombined + '\\n\\nJSON Format:\\n{\\n \"emailType\": \"table_booking\" | \"room_hire\" | \"general_inquiry\" | \"invoice\" | \"spam\" | \"promotion\",\\n \"priority\": \"high\" | \"medium\" | \"low\",\\n \"isBooking\": true | false,\\n \"extracted\": {\\n \"firstname\": null,\\n \"lastname\": null,\\n \"email\": null,\\n \"phone\": null,\\n \"date\": null,\\n \"time\": null,\\n \"endTime\": null,\\n \"guests\": null,\\n \"seating\": \"Inside\" | \"Outside\" | null,\\n \"eventType\": null,\\n \"specialRequests\": null,\\n \"consent\": \"Yes\" | \"No\" | null\\n },\\n \"summary\": \"Kurze Zusammenfassung\",\\n \"suggestedReply\": \"Professionelle Antwort auf Englisch\",\\n \"requiresHumanReview\": false,\\n \"confidence\": \"high\" | \"medium\" | \"low\"\\n}\\n\\nWichtig:\\n- Datum immer DD/MM/YYYY\\n- Zeit immer HH:MM\\n- Bei WPForms Bookings: emailType = \"table_booking\"\\n- Bei unklaren Emails: confidence = \"low\"\\n- suggestedReply nur bei general_inquiry\\n- Antworte NUR mit JSON' }}", "options": { "systemMessage": "You are a professional precise Email-Analyse-Assistent. Answer only with valid JSON." } }, "id": "202002d7-5438-4402-878e-961d1f56afd0", "name": "OpenRouter Agent - Classifier (Test)", "type": "@n8n/n8n-nodes-langchain.agent", "position": [ 816, 256 ], "typeVersion": 1.7 }, { "parameters": { "jsCode": "// Parse OpenRouter Output\nconst input = $input.all()[0].json;\nconst rawOutput = input.output || input.text || input.content || JSON.stringify(input);\n\nlet parsed;\ntry {\n const jsonMatch = rawOutput.match(/\\{[\\s\\S]*\\}/);\n if (jsonMatch) {\n parsed = JSON.parse(jsonMatch[0]);\n } else {\n throw new Error('No JSON found');\n }\n} catch(e) {\n parsed = {\n emailType: 'general_inquiry',\n priority: 'medium',\n isBooking: false,\n extracted: {},\n summary: 'Could not parse email',\n suggestedReply: '',\n requiresHumanReview: true,\n confidence: 'low'\n };\n}\n\n// Datum formatieren falls vorhanden\nconst formatDate = (d) => {\n if (!d) return null;\n if (d.includes('/')) return d; // Bereits formatiert\n // Andere Formate umrechnen\n return d;\n};\n\nreturn {\n json: {\n ...parsed,\n extracted: {\n ...parsed.extracted,\n date: formatDate(parsed.extracted?.date)\n },\n emailId: $('Prepare Email Data (Test)').item.json.emailId,\n emailFrom: $('Prepare Email Data (Test)').item.json.emailFrom,\n emailFromName: $('Prepare Email Data (Test)').item.json.emailFromName,\n emailSubject: $('Prepare Email Data (Test)').item.json.emailSubject,\n rawBody: $('Prepare Email Data (Test)').item.json.emailBody\n }\n};" }, "id": "1d00cb01-958a-453f-ba73-3d54224d6f1f", "name": "Parse Classification (Test)", "type": "n8n-nodes-base.code", "position": [ 1120, 256 ], "typeVersion": 2 }, { "parameters": { "jsCode": "// Datenvalidierung\nconst extracted = $input.all()[0].json.extracted;\nconst errors = [];\n\n// Datum pr√ºfen (DD/MM/YYYY)\nif (extracted.date && !/^(0[1-9]|[12][0-9]|3[01])\\/([0][1-9]|1[0-2])\\/\\d{4}$/.test(extracted.date)) {\n errors.push('Ung√ºltiges Datum (erwartet: DD/MM/YYYY)');\n}\n\n// Zeit pr√ºfen (HH:MM)\nif (extracted.time && !/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(extracted.time)) {\n errors.push('Ung√ºltige Zeit (erwartet: HH:MM)');\n}\n\n// G√§stezahl pr√ºfen (1-50)\nif (extracted.guests && (isNaN(extracted.guests) || extracted.guests < 1 || extracted.guests > 50)) {\n errors.push('Ung√ºltige G√§stezahl (erwartet: 1-50)');\n}\n\nreturn {\n json: {\n ...$input.all()[0].json,\n validationErrors: errors.length > 0 ? errors : null,\n requiresHumanReview: errors.length > 0 || $input.all()[0].json.requiresHumanReview\n }\n};" }, "id": "a1b2c3d4-5678-90ef-ghij-klmnopqrstuv", "name": "Validate Data (Test)", "type": "n8n-nodes-base.code", "position": [ 1300, 256 ], "typeVersion": 2 }, { "parameters": { "rules": { "values": [ { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "loose", "version": 2 }, "conditions": [ { "id": "booking-check", "leftValue": "={{ $json.emailType }}", "rightValue": "table_booking", "operator": { "type": "string", "operation": "equals" } } ], "combinator": "and" }, "renameOutput": true, "outputKey": "Table Booking" }, { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "loose", "version": 2 }, "conditions": [ { "id": "room-check", "leftValue": "={{ $json.emailType }}", "rightValue": "room_hire", "operator": { "type": "string", "operation": "equals" } } ], "combinator": "and" }, "renameOutput": true, "outputKey": "Room Hire" }, { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "loose", "version": 2 }, "conditions": [ { "id": "inquiry-check", "leftValue": "={{ $json.emailType }}", "rightValue": "general_inquiry", "operator": { "type": "string", "operation": "equals" } } ], "combinator": "and" }, "renameOutput": true, "outputKey": "General Inquiry" }, { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "loose", "version": 2 }, "conditions": [ { "id": "invoice-check", "leftValue": "={{ $json.emailType }}", "rightValue": "invoice", "operator": { "type": "string", "operation": "equals" } } ], "combinator": "and" }, "renameOutput": true, "outputKey": "Invoice" }, { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "loose", "version": 2 }, "conditions": [ { "id": "spam-check", "leftValue": "={{ $json.emailType }}", "rightValue": "spam", "operator": { "type": "string", "operation": "equals" } } ], "combinator": "and" }, "renameOutput": true, "outputKey": "Spam" }, { "conditions": { "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "loose", "version": 2 }, "conditions": [ { "id": "human-review", "leftValue": "={{ $json.requiresHumanReview }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" } } ], "combinator": "and" }, "renameOutput": true, "outputKey": "Human Review" } ] }, "looseTypeValidation": true, "options": { "fallbackOutput": "extra" } }, "id": "c71dcb7d-4160-46c4-a187-67ba39408be4", "name": "Route by Email Type (Test)", "type": "n8n-nodes-base.switch", "position": [ 1500, 256 ], "typeVersion": 3.3 }, { "parameters": { "documentId": { "__rl": true, "value": "https://docs.google.com/spreadsheets/d/1RMZ6Bk4ZNUc0LtpylPArwD_92FLvaYND8z9u0SnnB-s/edit?gid=1", "mode": "url" }, "sheetName": { "__rl": true, "value": "gid=1", "mode": "list", "cachedResultName": "CapacityLimits" }, "options": {} }, "id": "d5d98f4a-48ed-466e-ab73-2e1e853af9ec", "name": "Get Capacity Limits (Test)", "type": "n8n-nodes-base.googleSheets", "position": [ 1700, -100 ], "typeVersion": 4.7, "credentials": { "googleSheetsOAuth2Api": { "id": "fTHw5Rb2HaLSh7wV", "name": "Google Sheets account" } } }, { "parameters": { "documentId": { "__rl": true, "value": "https://docs.google.com/spreadsheets/d/1RMZ6Bk4ZNUc0LtpylPArwD_92FLvaYND8z9u0SnnB-s/edit?gid=0#gid=0", "mode": "url" }, "sheetName": { "__rl": true, "value": "gid=0", "mode": "list", "cachedResultName": "Sheet1" }, "options": { "valueRenderMode": "formula" } }, "id": "e5f6g7h8-9012-34ij-klmn-opqrstuvwxyz", "name": "Get All Bookings (Test)", "type": "n8n-nodes-base.googleSheets", "position": [ 1700, 64 ], "typeVersion": 4.7, "credentials": { "googleSheetsOAuth2Api": { "